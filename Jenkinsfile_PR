pipeline {
    agent any
    environment {
    DOCKER_BUILDKIT=1
    }
    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }
    stages {
        stage('Build') {
            steps {
                sh "docker build -t sjournal-docker --build-arg TEST_ENV=local_publish ."
            }
        }
        stage('Test') {
            steps {
                // Run Tests
                sh 'mkdir -p reports'
                sh 'docker run -v $WORKSPACE/reports:/app/reports sjournal-docker python -m pytest --test_environment=local_publish'
            }
        }
    }
    post {
        always {
            sh "ls"
            sh "ls reports"
            sh "echo RUNNING JUNIT PLUGIN"
            junit 'reports/report.xml'

            // Remove all exited containers and volumes
            sh "docker ps -a -q -f status=exited | xargs docker rm -v"
        }
        failure {
            sh "echo Do something on Failure"
        }
    }
}