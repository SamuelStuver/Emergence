pipeline {
    agent any
    environment {
    DOCKER_BUILDKIT=1
    }
    options {
        disableConcurrentBuilds()
        ansiColor('xterm')
    }
    stages {
        stage('Build') {
            steps {
                sh "docker build -t sjournal-docker-localpublish -f Dockerfile_test --build-arg TEST_ENV=local_publish ."
            }
        }
        stage('Test') {
            steps {
                // Run Tests
                sh 'mkdir -p reports'
                // sh 'docker run -t -v $WORKSPACE/reports:/app/reports sjournal-docker-localpublish python -m pytest --color=yes --test_environment=local_publish'
            }
        }
    }
    post {
        always {
            sh "ls"
            sh "ls reports"

            script { try {echo "BRANCH_NAME:        $BRANCH_NAME"} catch (Exception e) {echo "BRANCH_NAME:        NOT SET "" + e.toString()} }
            script { try {echo "BRANCH_IS_PRIMARY:  $BRANCH_IS_PRIMARY"} catch (Exception e) {echo "BRANCH_IS_PRIMARY:  NOT SET "" + e.toString()} }
            script { try {echo "CHANGE_ID:          $CHANGE_ID"} catch (Exception e) {echo "CHANGE_ID:          NOT SET "" + e.toString()} }
            script { try {echo "CHANGE_TITLE:       $CHANGE_TITLE"} catch (Exception e) {echo "CHANGE_TITLE:       NOT SET "" + e.toString()} }
            script { try {echo "CHANGE_TARGET:      $CHANGE_TARGET"} catch (Exception e) {echo "CHANGE_TARGET:      NOT SET "" + e.toString()} }
            script { try {echo "CHANGE_BRANCH:      $CHANGE_BRANCH"} catch (Exception e) {echo "CHANGE_BRANCH:      NOT SET "" + e.toString()} }
            script { try {echo "BUILD_NUMBER:       $BUILD_NUMBER"} catch (Exception e) {echo "BUILD_NUMBER:       NOT SET "" + e.toString()} }
            script { try {echo "BUILD_DISPLAY_NAME: $BUILD_DISPLAY_NAME"} catch (Exception e) {echo "BUILD_DISPLAY_NAME: NOT SET "" + e.toString()} }
            script { try {echo "JOB_NAME:           $JOB_NAME"} catch (Exception e) {echo "JOB_NAME:           NOT SET "" + e.toString()} }
            script { try {echo "JOB_BASE_NAME:      $JOB_BASE_NAME"} catch (Exception e) {echo "JOB_BASE_NAME:      NOT SET "" + e.toString()} }
            
            sh "echo RUNNING JUNIT PLUGIN"
            withChecks('Pytest Execution - Local Publish') {
                junit (
                    testResults: 'reports/report.xml',
                    keepLongStdio: true,
                )
            }
            publishHTML (target : [allowMissing: false,
                        alwaysLinkToLastBuild: true,
                        keepAll: false,
                        reportDir: 'reports',
                        reportFiles: 'report.html',
                        reportName: 'Pytest Report'])

            // Remove all exited containers and volumes
            sh "docker ps -a -q --filter ancestor=sjournal-docker-localpublish | xargs docker stop"
            sh "docker ps -a -q --filter ancestor=sjournal-docker-localpublish | xargs docker rm"
            // sh "docker system prune --force -a --volumes"
        }
        failure {
            sh "echo TODO: Do something on Failure"
        }
    }
}